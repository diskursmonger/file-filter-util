# **Утилита фильтрации содержимого файлов**
**Версия Java:** 21

**Система сборки:** Gradle 8.7

**Сторонние библиотеки:**

Lombok 1.18.38 "org.projectlombok:lombok:1.18.38"

Picocli 4.7.7 'info.picocli:picocli:4.7.7'

Picocli CodeGen 4.7.7 'info.picocli:picocli-codegen:4.7.7'

ShadowJar 8.1.1 https://gradleup.com/shadow/


## Инструкция по запуску
При клонировании репозитория необходимо прописать в корневой папке проекта:
`./gradlew shadowJar`

Собранный fat-jar сохранится в `(build/libs)` под названием util.jar.

Запуск из папки где находится util.jar:
`java -jar util.jar [options] <inputFiles...>`

Аргументы командной строки:
* `-o <path>` (путь для результатов)
* `-p <prefix>` (префикс имен выходных файлов)
* `-a` (флаг для добавления в существующие выходные файлы)
* `-s или -f` (для краткой и полной статистики соответственно)
* `<inputFiles…>` (пути до входных файлов)

Если прописаны флаги `-o, -p,` то после них обязательно должны идти ожидаемые аргументы.

Флаг `-a` добавляет строки в существующие выходные файлы. Если выходного файла не было, то он будет создан и запись будет вестись с пустого файла.

Одновременно недопустимо использование флагов `-s и -f`. Флаги опциональны, в случае их отстутствия статистика собираться не будет.

Должен быть хотя бы один входной файл.

## Особенности реализации

Парсинг аргументов командной строки происходит с помощью библиотеки Picocli, были заведены необходимые аннотации. В случае некорректных аргументов выбрасываются исключения которые обрабатываются в `ApplicationService`.

Все аргументы командной строки собираются в `(domain/config/AppConfig.java)`, класс-запись. В него также добавлены default названия для выходных файлов. В AppConfig будут хранится все необходимые настройки для работы программы: пути до входных и выходных файлов, флаг статистики, флаг append.

Через Picocli идет обработка только синтаксической корректности ввода аргументов.

Для семантической проверки AppConfig были заведены валидаторы `(domain/validation)`. В случае ошибок выбрасываются исключения типа ValidationException.

Валидация предусматривает случаи:
* Имя префикса недопустимо для текущей ОС
* Входные файлы:
  
  – Входного файла не существует
  
  – Нет доступа к прочтению входного файла
  
  – Входной файл - директория
  
  – Повтор входного файла
* Имя входного и выходного файлов совпадают
* Путь для результатов:
  
  – Выходной путь указывает на файл
  
  – Нет доступа для записи
  
  – Нет доступа для создания директории
  
  – Недопустимое название у директории для текущей ОС
  
  – Выходной путь указывает на файл

При успешной валидации AppConfig запускается основная задача программы `(filtering/FileFilterService.java)`.

За входные файлы отвечает `InputManager`, за выходные `OutputManager`.
Входные файлы открываются все сразу, а выходные только в случае если OutputManager получил запрос на запись в соответствующий файл.

Реализовала класс-обертку `FileLineIterator` над `Iterator`, который открывает и закрывает `Stream<String>` для соответствующего входного файла, и также хранит `Iterator<String>`, чтобы через hasNext() и next() можно было считывать следующую строку из stream и при достижении конца stream закрывать его.

При вызове `InputManager.open()` создаются FileLineIterator-ы для input-файлов, они добавляются в `Deque<FileLineIterator> q`. При чтении `inputManager.readLine()` из очереди берется первый итератор и если это не конец файла, то читается следующая строка. Далее этот итератор кладется в конец очереди.

Далее через `(domain/OutputTypeClassifier.java)` определяется через regex-ы к какому типу относится строка.

После определения типа передаем считанную строку и тип `outputManager.write(line, type)`.

По типу получаем необходимый `BufferWriter()`, записываем в соответствующий типу output-файл.

В соответствии с флагом статистики (NONE, SHORT и FULL) создается нужный `StatisticsCollector`. Если стоит флаг NONE, то при вызове `statisticsCollector.update(line, type)`ничего не происходит.

Статистика хранится в `(domain/statistics/data)`, предоставляются функции для ее обновления. Соответствующий StatisticsCollector их вызывает.

Для вывода статистики в консоль реализован `(filtering/report/ConsoleStatisticsReporter.java)`.

Алгоритм работает до тех пор, пока в очереди еще осталось то, что читать.

В некоторых классах, например `IntegerStatistics`, были добавлены аннотации Lombok для автоматической генерации getter-ов.

Все ресурсы AutoCloseable, были переопределены close() для корректного их закрытия.
